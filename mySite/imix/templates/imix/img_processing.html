<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Processor</title>
    <link rel="stylesheet" href="{% static 'css/header.css' %}">
    <link rel="stylesheet" href="{% static 'css/footer.css' %}">
    <link rel="stylesheet" href="{% static 'css/img_processing.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body class="bg-dark text-white">
    
    {% include "imix/header.html" %}

    <form id="img-form" action="{% url 'img_process' %}" method="POST" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="container-fluid mt-3">
          <div class="row main-section">
              <div class="col-sm-8 img-section d-flex justify-content-center">
                  <div class="upload-container" id="upload-container">
                    <div class="browse" id="browse-section">
                      <p>Drag and drop an image here, or</p>
                      <label for="file-input">Browse</label>
                      <input type="file" id="file-input" name="image" accept="image/*">
                    </div>
                    <div id="preview" style="display: none;">
                      <!-- Image will be displayed here -->
                    </div>
                  </div>
              </div>
  
              <div class="col-sm-4 menu-section d-flex justify-content-center align-items-center">
                <div class="card shadow-lg border-0" id="tools-card">
                    <div class="card-body">
                        
                      <div class="card-heading d-flex justify-content-center">
                            <h4>Select your image repair tool</h4>
                      </div>
                        
                      <div class="tools-section d-flex flex-wrap justify-content-center">
                        <button 
                          class="tool-btn" type="button" value="grayscale"
                          onclick="sendButtonID(this.value)">Grayscale</button>

                        <button 
                          class="tool-btn" type="button" value="resizing"
                          onclick="sendButtonID(this.value)">Resizing</button>
                        
                        <button 
                          class="tool-btn" type="button" value="blur" 
                          onclick="sendButtonID(this.value)">Blur</button>
                        
                        <button 
                          class="tool-btn" type="button" value="edge_detection" 
                          onclick="sendButtonID(this.value)">Edge Detection</button>
                        
                        <button 
                          class="tool-btn" type="button" value="threshold" 
                          onclick="sendButtonID(this.value)">Threshold</button>
                        
                        <button 
                          class="tool-btn" type="button" value="morphology" 
                          onclick="sendButtonID(this.value)">Morphology</button>
                        
                        <button 
                          class="tool-btn" type="button" value="brightness" 
                          onclick="sendButtonID(this.value)">Brightness</button>
                        
                        <button 
                          class="tool-btn" type="button" value="adjust_rgb"
                          onclick="sendButtonID(this.value)">Adjust RGB</button>
                        
                        <button 
                          class="tool-btn" type="button" value="plot_rgb" 
                          onclick="sendButtonID(this.value)">Plot RGB</button>
                    </div>
                         

                      <div class="slider-section">
                        
                      </div>

                      <div class="confirm-section d-flex justify-content-center">
                        <button class="btn btn-primary mt-4" type="submit" id="submit_btn">
                          Apply Filter
                        </button>
                      </div>

                    </div>
                </div>
              </div>            
          </div>
      </div>
    </form>

    <!-- New container for the "Browse Again" button -->
    <div class="container" id="browse-again-container" style="display: none;">
      <button class="btn btn-primary" id="reset-button">Browse Again</button>
    </div>

    {% if file_url %}
      <div class="container mt-3">
        <h4>Uploaded Image</h4>
        <img src="{{ file_url }}" alt="Uploaded Image" class="img-fluid">
      </div>
    {% endif %}

    {% include "imix/footer.html" %}

<script src={% static 'js/img_processing.js' %}></script>
<script>
  window.onload = function () {
    let storedScrollPosition = localStorage.getItem('scrollPosition');

    if (storedScrollPosition) {
      // Restore the scroll position from localStorage (after form submission)
      window.scrollTo(0, storedScrollPosition);
      localStorage.removeItem('scrollPosition'); // Clear storage after use
    } else {
      // Use Django's scroll_height for initial load
      window.scrollTo(0, {{ scroll_height|default:0 }});
    }
  };

  document.getElementById("img-form").onsubmit = function (event) {
    event.preventDefault(); // Prevent the default form submission

    const formData = new FormData(document.getElementById("img-form"));

    fetch("{% url 'img_process' %}", {
        method: "POST",
        body: formData,
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error("Network response was not ok");
        }
        return response.blob(); // Convert response to blob
    })
    .then(blob => {
        let imageUrl = URL.createObjectURL(blob); // Create image URL
        console.log("Image URL:", imageUrl); // Log the image URL
        document.getElementById("preview").innerHTML = `<img src="${imageUrl}" class="img-fluid"/>`;
        document.getElementById("preview").style.display = "block";
        document.getElementById("browse-section").style.display = "none";
        document.getElementById("browse-again-container").style.display = "block";
    })
    .catch(error => {
        console.error("Error:", error);
        alert("An error occurred while processing the image. Please try again.");
    });
};

  function sendButtonID(buttonID) {
    fetch("{% url 'img_process' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ button_id: buttonID })
    })
    .then(response => response.json())
    .then(data => console.log("Server Response:", data))
    .catch(error => console.error("Error:", error));
  }

  document.getElementById("reset-button").onclick = function () {
    document.getElementById("preview").style.display = "none";
    document.getElementById("browse-section").style.display = "block";
    document.getElementById("browse-again-container").style.display = "none";
    document.getElementById("file-input").value = ""; // Clear the file input
  };

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous">
</script>
</body>
</html>